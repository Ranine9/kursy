<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Użytkownika - Nowy Koncept</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Jasnoszare tło */
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-icon {
            transition: all 0.3s ease;
        }
        .sidebar-icon:hover {
            transform: scale(1.1);
        }
        .material-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .material-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Usunięto .upload-button i style modala, bo modal jest usuwany */

        .loader { 
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex h-screen bg-gray-100">

    <aside id="desktopSidebar" class="w-72 bg-gray-800 text-white p-6 space-y-6 hidden md:flex flex-col justify-between shadow-lg">
        <div>
            <div class="text-3xl font-bold mb-10 flex items-center text-indigo-400">
                <i class="fas fa-rocket mr-3 text-4xl"></i>
                <span>Materiały<span class="text-white">PRO</span></span>
            </div>
            <nav class="space-y-2" id="desktopNav">
                <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg sidebar-nav-link active" data-section="my-materials-section">
                    <i class="fas fa-folder-open w-6 h-6 sidebar-icon text-indigo-300"></i>
                    <span>Moje Materiały</span>
                </a>
                <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg sidebar-nav-link" data-section="account-settings-section">
                    <i class="fas fa-cog w-6 h-6 sidebar-icon text-gray-400"></i>
                    <span>Ustawienia Konta</span>
                </a>
                <a href="/material_gallery.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg">
                    <i class="fas fa-swatchbook w-6 h-6 sidebar-icon text-indigo-300"></i>
                    <span>Galeria Materiałów</span>
                </a>
                <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg opacity-50 cursor-not-allowed" title="Funkcjonalność w przygotowaniu">
                    <i class="fas fa-share-alt w-6 h-6 sidebar-icon text-indigo-300"></i>
                    <span>Udostępnione</span>
                </a>
                <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg opacity-50 cursor-not-allowed" title="Funkcjonalność w przygotowaniu">
                    <i class="fas fa-star w-6 h-6 sidebar-icon text-indigo-300"></i>
                    <span>Ulubione</span>
                </a>
            </nav>
        </div>
        <button id="logoutButtonDesktop" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-red-700 bg-red-600 text-white transition-colors duration-200 text-lg">
            <i class="fas fa-sign-out-alt w-6 h-6 sidebar-icon"></i>
            <span>Wyloguj się</span>
        </button>
    </aside>

    <div id="mobileSidebar" class="fixed inset-0 flex z-40 md:hidden hidden"> {/* Domyślnie ukryty */}
        <div id="mobileSidebarOverlay" class="fixed inset-0 bg-black opacity-50"></div>
        <aside class="relative w-72 bg-gray-800 text-white p-6 space-y-6 flex flex-col justify-between shadow-xl">
            <div>
                <div class="text-3xl font-bold mb-10 flex items-center text-indigo-400">
                    <i class="fas fa-rocket mr-3 text-4xl"></i>
                    <span>Materiały<span class="text-white">PRO</span></span>
                </div>
                <nav class="space-y-2" id="mobileNav">
                     <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg sidebar-nav-link active" data-section="my-materials-section">
                        <i class="fas fa-folder-open w-6 h-6 sidebar-icon text-indigo-300"></i>
                        <span>Moje Materiały</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg sidebar-nav-link" data-section="account-settings-section">
                        <i class="fas fa-cog w-6 h-6 sidebar-icon text-gray-400"></i>
                        <span>Ustawienia Konta</span>
                    </a>
                     <a href="/material_gallery.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg">
                        <i class="fas fa-swatchbook w-6 h-6 sidebar-icon text-indigo-300"></i>
                        <span>Galeria Materiałów</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg opacity-50 cursor-not-allowed" title="Funkcjonalność w przygotowaniu">
                        <i class="fas fa-share-alt w-6 h-6 sidebar-icon text-indigo-300"></i>
                        <span>Udostępnione</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-lg opacity-50 cursor-not-allowed" title="Funkcjonalność w przygotowaniu">
                        <i class="fas fa-star w-6 h-6 sidebar-icon text-indigo-300"></i>
                        <span>Ulubione</span>
                    </a>
                </nav>
            </div>
             <button id="logoutButtonMobile" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-red-700 bg-red-600 text-white transition-colors duration-200 text-lg">
                <i class="fas fa-sign-out-alt w-6 h-6 sidebar-icon"></i>
                <span>Wyloguj się</span>
            </button>
        </aside>
    </div>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <button id="menuButton" class="md:hidden mr-4 text-gray-700 hover:text-indigo-600">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <h1 id="main-section-title" class="text-3xl font-semibold text-gray-800">Moje Materiały</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button class="text-gray-500 hover:text-gray-700 relative" title="Powiadomienia (wkrótce)">
                    <i class="fas fa-bell text-xl"></i>
                </button>
                <div class="relative">
                    <img id="userAvatar" src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="Awatar użytkownika" class="w-10 h-10 rounded-full cursor-pointer">
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 border border-gray-200">
                        <span id="dropdownUsername" class="block px-4 py-2 text-sm text-gray-500 truncate">Ładowanie...</span>
                        <hr class="my-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="activateSection('account-settings-section', event)">Profil i Ustawienia</a>
                        <button id="logoutButtonDropdown" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Wyloguj</button>
                    </div>
                </div>
            </div>
        </header>

        <section id="my-materials-section" class="main-content-section">
            <div id="my-materials-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div id="my-materials-loader" class="col-span-full"><div class="loader"></div></div>
                <p id="no-my-materials-message" class="hidden col-span-full text-center text-gray-500 py-10">Nie posiadasz jeszcze żadnych materiałów.</p>
                <p id="error-my-materials-message" class="hidden col-span-full text-center text-red-500 py-10">Wystąpił błąd podczas ładowania materiałów.</p>
            </div>
        </section>

        <section id="account-settings-section" class="main-content-section hidden">
            <h2 class="text-3xl font-semibold text-gray-800 mb-6">Ustawienia Konta</h2>
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <p class="text-gray-600">Tutaj w przyszłości znajdą się opcje zmiany hasła, adresu email, preferencji powiadomień itp.</p>
                <p class="mt-2 text-gray-600">ID Użytkownika: <span id="user-id-placeholder" class="font-mono">ładowanie...</span></p>
            </div>
        </section>
    </main>

    
    <div id="toastMessage" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg hidden transition-opacity duration-300 opacity-0">
        <p id="toastText"></p>
    </div>

<script>
    const menuButton = document.getElementById('menuButton');
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay');
    const desktopNavLinks = document.querySelectorAll('#desktopNav .sidebar-nav-link');
    const mobileNavLinks = document.querySelectorAll('#mobileNav .sidebar-nav-link');
    const mainContentSections = document.querySelectorAll('.main-content-section');
    const mainSectionTitle = document.getElementById('main-section-title');
    
    const userAvatar = document.getElementById('userAvatar');
    const profileDropdown = document.getElementById('profileDropdown');
    const dropdownUsername = document.getElementById('dropdownUsername');
    
    const materialsGrid = document.getElementById('my-materials-grid');
    const materialsLoader = document.getElementById('my-materials-loader');
    const noMaterialsMsg = document.getElementById('no-my-materials-message');
    const errorMaterialsMsg = document.getElementById('error-my-materials-message');
    
    const toastMessageEl = document.getElementById('toastMessage');
    const toastTextEl = document.getElementById('toastText');

    const userIdPlaceholder = document.getElementById('user-id-placeholder');

    async function fetchUserDataForConcept() {
        try {
            const response = await fetch('/api/user', { credentials: 'include' });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    showToast('Sesja wygasła. Przekierowuję...', false);
                    setTimeout(() => { window.location.href = '/login.html?redirect=/dashboard_light_concept.html'; }, 2500);
                } else {
                    showToast(`Błąd ładowania danych użytkownika: ${response.status}`, false);
                }
                return null;
            }
            const userData = await response.json();
            if (userData.username) {
                if(dropdownUsername) dropdownUsername.textContent = userData.username;
                if (userAvatar && userData.username) {
                    userAvatar.alt = `Awatar ${userData.username}`;
                    // Prosta logika inicjałów
                    const initials = userData.username.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
                    const avatarPlaceholder = userAvatar.parentElement.querySelector('span'); // Jeśli masz span na inicjały
                    if(avatarPlaceholder) avatarPlaceholder.textContent = initials;
                    else userAvatar.src = `https://placehold.co/40x40/E2E8F0/718096?text=${initials}`; // Fallback z inicjałami
                }
                const userIdSettingsPlaceholder = document.getElementById('user-id-placeholder');
                if (userIdSettingsPlaceholder && userData.userId) userIdSettingsPlaceholder.textContent = userData.userId;
            }
            return userData;
        } catch (error) {
            console.error('Nie udało się pobrać danych użytkownika:', error);
            showToast('Nie udało się załadować danych użytkownika.', false);
            return null;
        }
    }

    function getIconForFileType(fileType, category) {
        if (category) {
            const catLower = category.toLowerCase();
            if (catLower.includes('kurs') || catLower.includes('video')) return 'fa-play-circle';
            if (catLower.includes('ebook') || catLower.includes('książka')) return 'fa-book-open';
            if (catLower.includes('szablon') || catLower.includes('template')) return 'fa-drafting-compass';
            if (catLower.includes('poradnik') || catLower.includes('guide')) return 'fa-graduation-cap';
            if (catLower.includes('audio') || catLower.includes('podcast')) return 'fa-headphones';
            if (catLower.includes('grafika') || catLower.includes('design')) return 'fa-image';
            if (catLower.includes('kod') || catLower.includes('programowanie')) return 'fa-code';
        }
        if (fileType) {
            if (fileType.includes('pdf')) return 'fa-file-pdf';
            if (fileType.includes('word') || fileType.includes('document')) return 'fa-file-word';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fa-file-excel';
            if (fileType.includes('presentation') || fileType.includes('powerpoint')) return 'fa-file-powerpoint';
            if (fileType.startsWith('image/')) return 'fa-file-image';
            if (fileType.startsWith('video/')) return 'fa-file-video';
            if (fileType.startsWith('audio/')) return 'fa-file-audio';
        }
        return 'fa-file';
    }

    function createMaterialCardFromConcept(material) {
        const acquiredDate = material.acquired_at ? new Date(material.acquired_at).toLocaleDateString('pl-PL', {day: '2-digit', month: 'short', year: 'numeric'}) : 'Brak daty';
        const fileTypeOrCategory = material.category || (material.file_url ? material.file_url.split('.').pop().toUpperCase() : 'Plik');
        const iconClass = getIconForFileType(material.file_url ? material.file_url.split('.').pop() : '', material.category);
        
        const thumbnailUrl = material.cover_image_url || `https://placehold.co/600x400/E0E0E0/777?text=${fileTypeOrCategory}`;
        const imageElement = material.cover_image_url 
            ? `<img src="${thumbnailUrl}" alt="Miniatura: ${material.title}" class="w-full h-40 object-cover group-hover:scale-105 transition-transform duration-300">`
            : `<div class="w-full h-40 bg-gray-200 flex items-center justify-center group-hover:bg-gray-300 transition-colors duration-300"><i class="fas ${iconClass} text-5xl text-gray-400 group-hover:text-indigo-500 transition-colors duration-300"></i></div>`;

        // Usunięto przyciski Edytuj i Usuń
        return `
            <div class="material-card bg-white rounded-xl shadow-lg overflow-hidden group">
                ${imageElement}
                <div class="p-5">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1 truncate group-hover:text-indigo-600 transition-colors" title="${material.title}">${material.title}</h3>
                    <p class="text-sm text-gray-500 mb-1">Typ: ${material.category || 'Ogólny'}</p>
                    <p class="text-sm text-gray-500 mb-3">Nabyto: ${acquiredDate}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs bg-indigo-100 text-indigo-700 px-2.5 py-1 rounded-full">${material.category || 'Dokument'}</span>
                        <div class="text-gray-400 space-x-2">
                            ${material.file_url ? `<a href="${material.file_url}" download target="_blank" class="hover:text-indigo-600" title="Pobierz"><i class="fas fa-download"></i></a>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function fetchAndDisplayMyMaterialsForConcept() {
        if (!materialsGrid || !materialsLoader || !noMaterialsMsg || !errorMaterialsMsg) return;
        materialsLoader.classList.remove('hidden');
        materialsGrid.innerHTML = ''; 
        materialsGrid.appendChild(materialsLoader);
        noMaterialsMsg.classList.add('hidden');
        errorMaterialsMsg.classList.add('hidden');

        try {
            const response = await fetch('/api/my-materials', { credentials: 'include' });
            if (!response.ok) {
                throw new Error(`Błąd HTTP: ${response.status}`);
            }
            const materials = await response.json();
            materialsLoader.classList.add('hidden');

            if (materials.length === 0) {
                noMaterialsMsg.classList.remove('hidden');
            } else {
                materials.forEach(material => {
                    materialsGrid.insertAdjacentHTML('beforeend', createMaterialCardFromConcept(material));
                });
            }
        } catch (error) {
            console.error('Nie udało się pobrać materiałów:', error);
            materialsLoader.classList.add('hidden');
            errorMaterialsMsg.textContent = `Błąd ładowania materiałów: ${error.message}`;
            errorMaterialsMsg.classList.remove('hidden');
        }
    }
    
    function activateSection(sectionId, event) {
        if (event) event.preventDefault();
        mainContentSections.forEach(section => {
            section.classList.toggle('hidden', section.id !== sectionId);
        });
        
        const allNavLinks = [...desktopNavLinks, ...mobileNavLinks];
        allNavLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.section === sectionId);
            link.classList.toggle('bg-gray-700', link.dataset.section === sectionId && link.closest('#mobileNav'));
        });
        
        const activeLink = document.querySelector(`.sidebar-nav-link[data-section="${sectionId}"]`);
        if (mainSectionTitle && activeLink) {
            mainSectionTitle.textContent = activeLink.querySelector('span').textContent.trim();
        }
        localStorage.setItem('activeDashboardConceptTab', sectionId);
        if (mobileSidebar.classList.contains('flex') && !mobileSidebar.classList.contains('hidden')) { 
            mobileSidebar.classList.add('hidden');
            mobileSidebar.classList.remove('flex');
        }

        if (sectionId === 'my-materials-section') {
            fetchAndDisplayMyMaterialsForConcept();
        }
    }

    desktopNavLinks.forEach(link => {
        if(link.dataset.section) link.addEventListener('click', (e) => activateSection(link.dataset.section, e));
    });
    mobileNavLinks.forEach(link => {
         if(link.dataset.section) link.addEventListener('click', (e) => activateSection(link.dataset.section, e));
    });

    if (menuButton) {
        menuButton.addEventListener('click', () => {
            mobileSidebar.classList.remove('hidden');
            mobileSidebar.classList.add('flex'); 
        });
    }
    if (mobileSidebarOverlay) {
        mobileSidebarOverlay.addEventListener('click', () => {
            mobileSidebar.classList.add('hidden');
            mobileSidebar.classList.remove('flex');
        });
    }

    function toggleProfileDropdown() {
        if(profileDropdown) profileDropdown.classList.toggle('hidden');
    }
    if(userAvatar) userAvatar.addEventListener('click', (e) => {
        e.stopPropagation(); 
        toggleProfileDropdown();
    });
    window.addEventListener('click', function(event) { 
        if (profileDropdown && !profileDropdown.classList.contains('hidden') && !userAvatar.contains(event.target) && !profileDropdown.contains(event.target)) {
            profileDropdown.classList.add('hidden');
        }
    });

    function handleLogoutConcept() {
        fetch('/logout', { method: 'GET', credentials: 'include' })
            .then(response => { window.location.href = (response.ok && response.redirected) ? response.url : '/'; })
            .catch(error => { showToast('Problem z wylogowaniem.', false); window.location.href = '/'; });
    }
    const logoutButtonDesktopEl = document.getElementById('logoutButtonDesktop');
    const logoutButtonMobileEl = document.getElementById('logoutButtonMobile');
    const logoutButtonDropdownEl = document.getElementById('logoutButtonDropdown');

    if(logoutButtonDesktopEl) logoutButtonDesktopEl.addEventListener('click', handleLogoutConcept);
    if(logoutButtonMobileEl) logoutButtonMobileEl.addEventListener('click', handleLogoutConcept);
    if(logoutButtonDropdownEl) logoutButtonDropdownEl.addEventListener('click', handleLogoutConcept);
    
    function showToast(message, isSuccess = true) {
        if (!toastMessageEl || !toastTextEl) return;
        toastTextEl.textContent = message;
        toastMessageEl.classList.remove('hidden', 'bg-red-600', 'bg-green-600', 'opacity-0');
        toastMessageEl.classList.add(isSuccess ? 'bg-green-600' : 'bg-red-600', 'opacity-100');
        setTimeout(() => {
            toastMessageEl.classList.remove('opacity-100');
            toastMessageEl.classList.add('opacity-0');
            setTimeout(() => toastMessageEl.classList.add('hidden'), 300);
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await fetchUserDataForConcept();
        const savedTab = localStorage.getItem('activeDashboardConceptTab') || 'my-materials-section';
        const initialSectionLink = document.querySelector(`.sidebar-nav-link[data-section="${savedTab}"]`);
        
        if (initialSectionLink) {
            activateSection(savedTab);
        } else {
            activateSection('my-materials-section'); 
        }
    });
</script>
</body>
</html>
